- name: DJANGO_SECRET_KEY
  valueFrom:
    secretKeyRef:
      {{ include "flagsmith.api.secretKeySecretRef" . | nindent 6 }}

{{- with .Values.database }}

{{- if and .database.secret .database.key }}
- name: DJANGO_DB_NAME
  valueFrom:
    secretKeyRef:
      name: {{ .database.secret }}
      key: {{ .database.key }}
{{- else }}
- name: DJANGO_DB_NAME
  value: "postgres"
{{- end }}

{{- if and .username.secret .username.key }}
- name: DJANGO_DB_USER
  valueFrom:
    secretKeyRef:
      name: {{ .username.secret }}
      key: {{ .username.key }}
{{- else }}
- name: DJANGO_DB_USER
  value: "postgres"
{{- end }}

{{- if and .host.secret .host.key }}
- name: DJANGO_DB_HOST
  valueFrom:
    secretKeyRef:
      name: {{ .host.secret }}
      key: {{ .host.key }}
{{- else }}
- name: DJANGO_DB_HOST
  value: flagsmith-postgresql-hl
{{- end }}
{{- if and .portSecret .portKey }}
- name: DJANGO_DB_PORT
  valueFrom:
    secretKeyRef:
      name: {{ .portSecret }}
      key: {{ .portKey }}
{{- else if .port }}
- name: DJANGO_DB_PORT
  value: {{ .port | quote }}
{{ end }}
{{- if and .password.secret .password.key }}
- name: DJANGO_DB_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{ .password.secret }}
      key: {{ .password.key }}
{{- else }}
- name: DJANGO_DB_PASSWORD
  valueFrom:
    secretKeyRef:
      name: flagsmith-postgresql
      key: postgres-password
{{- end }}
{{- end }}
{{- if .Values.influxdb.enabled }}
- name: INFLUXDB_URL
  value: {{ .Values.influxdb.url | required "Must specify a URL for an external InfluxDB" }}
- name: INFLUXDB_BUCKET
  value: {{ .Values.influxdb.bucket | required "Must specify a bucket for an external InfluxDB" }}
- name: INFLUXDB_ORG
  value: {{ .Values.influxdb.organization | required "Must specify an organization for an external InfluxDB" }}
- name: INFLUXDB_TOKEN
  valueFrom:
    secretKeyRef:
      {{- if .Values.influxdb.token.secret }}
      name: {{ .Values.influxdb.token.secret | required "Must set secret name for external InfluxDB secret" }}
      key: {{ .Values.influxdb.token.key | required "Must set key for external InfluxDB secret" }}
      {{- else }}
      name: {{ template "flagsmith.influxdb.fullname" . }}-external-auth
      key: admin-token
      {{- end }}
{{- else if .Values.UsePostgresForAnalytics.enabled }}
{{- if not .Values.taskProcessor.enabled }}
{{ fail "To use PostgreSQL for analytics, `taskProcessor.enabled` should be set to `true`" }}
{{- end}}
- name: USE_POSTGRES_FOR_ANALYTICS
  value: 'true'
{{- else }}
- name: DISABLE_ANALYTICS_FEATURES
  value: 'true'
{{- end }}
- name: DJANGO_ALLOWED_HOSTS
  value: '*'
{{- range $envName, $envValue := .Values.api.extraEnv }}
- name: {{ $envName }}
  value: {{ $envValue | quote }}
{{- end }}
- name: TASK_RUN_METHOD
  value: TASK_PROCESSOR
{{- range $envName, $secretKeyRef := .Values.api.extraEnvFromSecret }}
- name: {{ $envName }}
  valueFrom:
    secretKeyRef:
      name: {{ $secretKeyRef.secretName }}
      key: {{ $secretKeyRef.secretKey }}
{{- end }}
{{- if .Values.frontend.apiProxy.enabled }}
- name: USE_X_FORWARDED_HOST
  value: 'true'
{{- end }}
{{- if .Values.api.logging.format }}
- name: LOG_FORMAT
  value: {{ .Values.api.logging.format }}
{{- end }}
{{- if .Values.sse.enabled }}
- name: SSE_AUTHENTICATION_TOKEN
  valueFrom:
    secretKeyRef:
      {{ include "flagsmith.sse.authenticationTokenSecretRef" . | nindent 6}}
- name: SSE_SERVER_BASE_URL
  value: http://{{ include "flagsmith.fullname" . }}-sse.{{ .Release.Namespace }}:{{ .Values.service.sse.port }}
{{- end }}
