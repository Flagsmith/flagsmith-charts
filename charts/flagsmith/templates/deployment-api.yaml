apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "flagsmith.fullname" . }}-api
  labels:
    {{- include "flagsmith.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  selector:
    matchLabels:
      {{- include "flagsmith.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  replicas: {{ .Values.api.replicacount }}
  template:
    metadata:
      annotations:
        checksum/secrets-api: {{ include (print $.Template.BasePath "/secrets-api.yaml") . | sha256sum }}
        {{- if .Values.influxdb.enabled }}
        checksum/secrets-influxdb: {{ include (print $.Template.BasePath "/secrets-influxdb.yaml") . | sha256sum }}
        {{- end }}
        {{- if and .Values.influxdbExternal.enabled (not .Values.influxdbExternal.tokenFromExistingSecret.enabled) }}
        checksum/secrets-influxdb-external: {{ include (print $.Template.BasePath "/secrets-influxdb-external.yaml") . | sha256sum }}
        {{- end }}
{{- if .Values.api.podAnnotations }}
{{ toYaml .Values.api.podAnnotations | nindent 8 }}
{{- end }}
      labels:
        {{- include "flagsmith.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
        {{- if .Values.api.podLabels }}
{{ toYaml .Values.api.podLabels | indent 8 }}
        {{- end }}
    spec:
      {{- if .Values.api.affinity }}
      affinity:
{{ toYaml .Values.api.affinity | indent 4 }}
      {{- end }}
      {{- if .Values.api.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.api.nodeSelector | indent 4 }}
      {{- end }}
      {{- if .Values.api.tolerations }}
      tolerations:
{{ toYaml .Values.api.tolerations | indent 4 }}
      {{- end }}
      {{- if .Values.api.schedulerName }}
      schedulerName: "{{ .Values.api.schedulerName }}"
      {{- end }}
      {{- if .Values.api.image.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.api.image.imagePullSecrets | indent 4 }}
      {{- end }}
      initContainers:
      - name: wait-for-db
        image: {{ .Values.api.dbWaiter.image.repository }}:{{ .Values.api.dbWaiter.image.tag }}
        imagePullPolicy: {{ .Values.api.dbWaiter.image.imagePullPolicy }}
        command:
          - /wait-for-it.sh
          - --host={{ template "flagsmith.postgres.hostname" . }}
          - --port=5432
          - --timeout={{ .Values.api.dbWaiter.timeoutSeconds }}
      containers:
      - name: {{ .Chart.Name }}-api
        image: {{ .Values.api.image.repository }}:{{ .Values.api.image.tag | default (printf "v%s" .Chart.AppVersion) }}
        imagePullPolicy: {{ .Values.api.image.imagePullPolicy }}
        # command: ["sleep", "3600"]
        ports:
        - containerPort: {{ .Values.service.api.port }}
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              {{- if and .Values.databaseExternal.enabled .Values.databaseExternal.urlFromExistingSecret.enabled }}
              name: {{ .Values.databaseExternal.urlFromExistingSecret.name }}
              name: {{ .Values.databaseExternal.urlFromExistingSecret.key }}
              {{- else }}
              name: {{ template "flagsmith.fullname" . }}
              key: DATABASE_URL
              {{- end }}
{{- if .Values.influxdb.enabled }}
        - name: INFLUXDB_URL
          value: http://{{- template "flagsmith.influx.hostname" . -}}:8086
        - name: INFLUXDB_BUCKET
          value: {{ .Values.influxdb.adminUser.bucket }}
        - name: INFLUXDB_ORG
          value: {{ .Values.influxdb.adminUser.organization }}
        - name: INFLUXDB_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ template "influxdb.fullname" . }}-auth
              key: admin-token
{{- else if .Values.influxdbExternal.enabled }}
        - name: INFLUXDB_URL
          value: {{ .Values.influxdbExternal.url | required "Must specify a URL for an external InfluxDB" }}
        - name: INFLUXDB_BUCKET
          value: {{ .Values.influxdbExternal.bucket | required "Must specify a bucket for an external InfluxDB" }}
        - name: INFLUXDB_ORG
          value: {{ .Values.influxdbExternal.organization | required "Must specify an organization for an external InfluxDB" }}
        - name: INFLUXDB_TOKEN
          valueFrom:
            secretKeyRef:
              {{- if .Values.influxdbExternal.tokenFromExistingSecret.enabled }}
              name: {{ .Values.influxdbExternal.tokenFromExistingSecret.name | required "Must set secret name for external InfluxDB secret" }}
              key: {{ .Values.influxdbExternal.tokenFromExistingSecret.key | required "Must set key for external InfluxDB secret" }}
              {{- else }}
              name: {{ template "influxdb.fullname" . }}-external-auth
              key: admin-token
              {{- end }}
{{- end }}
        - name: DJANGO_ALLOWED_HOSTS
          value: '*'
{{- range $envName, $envValue := .Values.api.extraEnv }}
        - name: {{ $envName }}
          value: {{ $envValue | quote }}
{{- end }}

        livenessProbe:
          failureThreshold: {{ .Values.api.livenessProbe.failureThreshold }}
          httpGet:
            path: /
            port: {{ .Values.service.api.port }}
            scheme: HTTP
          initialDelaySeconds: {{ .Values.api.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.api.livenessProbe.periodSeconds }}
          successThreshold: {{ .Values.api.livenessProbe.successThreshold }}
          timeoutSeconds: {{ .Values.api.livenessProbe.timeoutSeconds }}
        readinessProbe:
          failureThreshold: {{ .Values.api.readinessProbe.failureThreshold }}
          httpGet:
            path: /
            port: {{ .Values.service.api.port }}
            scheme: HTTP
          initialDelaySeconds: {{ .Values.api.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.api.readinessProbe.periodSeconds }}
          successThreshold: {{ .Values.api.readinessProbe.successThreshold }}
          timeoutSeconds: {{ .Values.api.readinessProbe.timeoutSeconds }}
        resources:
{{ toYaml .Values.api.resources | indent 10 }}
